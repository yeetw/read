<script>
  function searchBookList(filter) {
    const normalizedFilter = (filter || '').trim().toLowerCase();
    const rawTokens = normalizedFilter === '' ? [] : normalizedFilter.split(/\s+/);
    const yearPattern = /^(?:19|20)\d{2}$/;
    const MIN_FILTER_YEAR = 2021;
    const yearTokenSet = new Set();
    rawTokens.forEach((token) => {
      if (!yearPattern.test(token)) {
        return;
      }
      const yearNumber = parseInt(token, 10);
      if (!Number.isNaN(yearNumber) && yearNumber >= MIN_FILTER_YEAR) {
        yearTokenSet.add(String(yearNumber));
      }
    });
    const contentTokens = rawTokens.filter((token) => !yearTokenSet.has(token));

    /* Elements begin with year- */
    const elements = document.querySelectorAll('[id^="year-"]');

    /* Then match `year-*-list` pattern */
    const pattern = /^year-\d+-list$/;
    const yearLists = Array.from(elements).filter(element => pattern.test(element.id));

    const isStarToken = (token) => token === 'star' || token === '⭐' || token === '⭐️';

    const matchesAllTokens = (li) => {
      if (contentTokens.length === 0) {
        return true;
      }

      const name = (li.dataset.name || li.textContent || '').toLowerCase();
      const author = (li.dataset.author || '').toLowerCase();
      const isbn = (li.getAttribute('isbn') || '').toLowerCase();
      const date = (li.getAttribute('date') || '').toLowerCase();
      const commentFromAttr = (li.dataset.comment || '').toLowerCase();
      let comment = commentFromAttr;
      if (!comment) {
        const tooltip = li.getElementsByClassName('tooltiptext');
        if (tooltip.length > 0) {
          comment = tooltip[0].textContent.toLowerCase();
        }
      }
      const isStarred = (li.getAttribute('star') || '').toLowerCase() === 'true';
      const searchableFields = [name, author, comment, isbn, date];

      return contentTokens.every((token) => {
        if (isStarToken(token)) {
          return isStarred;
        }
        return searchableFields.some((field) => field.indexOf(token) !== -1);
      });
    };

    /* Iterate through each year list. */
    for (let y = 0; y < yearLists.length; y++) {
      const yearList = yearLists[y];
      const year = yearList.id.replace('year-', '').replace('-list', '');
      const matchesYearFilter = yearTokenSet.size === 0 || yearTokenSet.has(year);
      yearList.style.display = matchesYearFilter ? 'block' : 'none';

      const yearHeader = document.getElementById('year-' + year);
      if (!yearHeader) {
        continue;
      }
      const yearTotal = yearHeader.querySelector('.year-total');

      if (!matchesYearFilter) {
        yearHeader.style.display = 'none';
        if (yearTotal) {
          yearTotal.style.display = 'none';
        }
        continue;
      }

      const lis = yearList.getElementsByTagName('li');
      let count = 0;
      for (var i = 0; i < lis.length; i++) {
        if (matchesAllTokens(lis[i])) {
          lis[i].style.display = 'list-item';
          count++;
        } else {
          lis[i].style.display = 'none';
        }
      }

      if (yearTotal) {
        yearTotal.textContent = `． ${count} 本`;
      }

      if (count == 0) {
        yearHeader.style.display = 'none';
        if (yearTotal) {
          yearTotal.style.display = 'none';
        }
      } else {
        yearHeader.style.display = 'block';
        if (yearTotal) {
          yearTotal.style.display = 'inline';
        }
      }
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const searchEle = document.getElementById('search');
    const inputEle = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const searchIcon = searchButton.querySelector('.search-icon');
    const closeIcon = searchButton.querySelector('.close-icon');

    searchButton.addEventListener('click', (e) => {
      const isExpanded = searchEle.classList.contains('search--expanded');
      if (!isExpanded) {
        inputEle.focus();
        searchIcon.style.display = 'none';
        closeIcon.style.display = 'block';
      } else {
        inputEle.value = '';
        searchBookList('');
        searchIcon.style.display = 'block';
        closeIcon.style.display = 'none';
      }
      searchEle.classList.toggle('search--expanded');
    });
    inputEle.addEventListener('input', (e) => {
      searchBookList(e.target.value);
    });

    /* Handle scroll event to fix search button on top. */
    const offset = searchEle.offsetTop;
    window.onscroll = function() {
      if (window.pageYOffset > offset) {
        searchEle.classList.add('search--fixed');
        document.getElementById('searchSpacer').classList.add('search__spacer');
      } else {
        searchEle.classList.remove('search--fixed');
        document.getElementById('searchSpacer').classList.remove('search__spacer');
      }
    };
  });
</script>

<div class="searchbox">
  <div class="search" id="search">
    <input type="text" class="search__input" id="searchInput" placeholder="" />
    <button class="search__button" id="searchButton">
      <svg class="search__icon search-icon" focusable="false" viewBox="0 0 24 24">
        <path
          d="M10.5,0.5c5.523,0,10,4.477,10,10s-4.477,10-10,10s-10-4.477-10-10S4.977,0.5,10.5,0.5z M23.5,23.5 l-5.929-5.929">
        </path>
      </svg>
      <svg class="search__icon close-icon" focusable="false" viewBox="0 0 24 24" style="display: none;">
        <path
          d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z">
        </path>
      </svg>
    </button>
  </div>
  <div id="searchSpacer" class="search__spacer"></div>
</div>
